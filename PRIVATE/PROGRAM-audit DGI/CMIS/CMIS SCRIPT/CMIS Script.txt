USE [DMIS]
GO
/****** Update CMIS Table    Script Date: 09/11/2009 10:45 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--CMIS_OFF_HD
IF NOT EXISTS (SELECT * FROM SYSCOLUMNS WHERE ID = OBJECT_ID('CMIS_OFF_HD') AND NAME = 'REFERENCENO')
ALTER TABLE CMIS_OFF_HD
ADD 	REFERENCENO	nvarchar(8)
GO
IF NOT EXISTS (SELECT * FROM SYSCOLUMNS WHERE ID = OBJECT_ID('CMIS_OFF_HD') AND NAME = 'PAIDBY')
ALTER TABLE CMIS_OFF_HD
ADD 	PAIDBY		nvarchar(1)
GO
IF NOT EXISTS (SELECT * FROM SYSCOLUMNS WHERE ID = OBJECT_ID('CMIS_OFF_HD') AND NAME = 'BANK')
ALTER TABLE CMIS_OFF_HD
ADD 	BANK		nvarchar(6)
GO
IF NOT EXISTS (SELECT * FROM SYSCOLUMNS WHERE ID = OBJECT_ID('CMIS_OFF_HD') AND NAME = 'ENTITY_CLASS')
ALTER TABLE CMIS_OFF_HD
ADD 	'ENTITY_CLASS	nvarchar(1)
GO

--CMIS_OFF_DT
IF NOT EXISTS (SELECT * FROM SYSCOLUMNS WHERE ID = OBJECT_ID('CMIS_OFF_DT') AND NAME = 'REFERENCENO')
ALTER TABLE CMIS_OFF_DT 
ADD	REFERENCENO	nvarchar(8)
GO


--CUSTOMER DEPOSIT
IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE ID = OBJECT_ID('CMIS_Deposits') )
CREATE TABLE [DBO].[CMIS_DEPOSITS](
	[CUSCDE] [NVARCHAR](6) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,
	[ORDATE] [SMALLDATETIME] NULL,
	[OR_NUM] [NVARCHAR](6) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,
	[AMOUNT] [DECIMAL](18, 2) NULL,
	[APPLIED] [NVARCHAR](1) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,
	[INVOICENO] [NVARCHAR](11) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,
	[INVOICETYPE] [NVARCHAR](2) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,
	[PAIDFOR] [NVARCHAR](10) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,
	[ID_DET] [NVARCHAR](10) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,
	[ID] [INT] IDENTITY(1,1) NOT NULL
) ON [PRIMARY]
GO

--CREDIT CARD BANK
IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE ID = OBJECT_ID('CMIS_CardBank'))
CREATE TABLE CMIS_CardBank
(
Cuscde		nvarchar(6)	CONSTRAINT pk_CMIS_CardBank_Cuscde PRIMARY KEY,
AcctName	nvarchar(150),
BANKCHARGES	DECIMAL(18,2),
EWT		DECIMAL(18,2),
ID		int IDENTITY(1,1) NOT NULL
)
GO


--MULTIPLE PAYMENT IN 1 OR

IF NOT EXISTS (SELECT * FROM SYSCOLUMNS WHERE ID=OBJECT_ID('CMIS_OFF_HD') AND NAME = 'DEPOSIT1')
	ALTER TABLE CMIS_OFF_HD
	ADD 	DEPOSIT1	BIT
	GO
IF NOT EXISTS (SELECT * FROM SYSCOLUMNS WHERE ID=OBJECT_ID('CMIS_OFF_HD') AND NAME = 'DEPOSIT2')
	ALTER TABLE CMIS_OFF_HD
	ADD 	DEPOSIT2	BIT
	GO
IF NOT EXISTS (SELECT * FROM SYSCOLUMNS WHERE ID=OBJECT_ID('CMIS_OFF_HD') AND NAME = 'DEPOSIT3')
	ALTER TABLE CMIS_OFF_HD
	ADD 	DEPOSIT3	BIT
	GO

	

IF NOT EXISTS (SELECT * FROM SYSCOLUMNS WHERE ID=OBJECT_ID('CMIS_OFF_HD') AND NAME = 'TOF1')
	ALTER TABLE CMIS_OFF_HD
	ADD		TOF1	NVARCHAR(1)
	GO
IF NOT EXISTS (SELECT * FROM SYSCOLUMNS WHERE ID=OBJECT_ID('CMIS_OFF_HD') AND NAME = 'TOF2')
	ALTER TABLE CMIS_OFF_HD
	ADD		TOF2	NVARCHAR(1)
	GO
IF NOT EXISTS (SELECT * FROM SYSCOLUMNS WHERE ID=OBJECT_ID('CMIS_OFF_HD') AND NAME = 'TOF3')
	ALTER TABLE CMIS_OFF_HD
	ADD		TOF3	NVARCHAR(1)
	GO


SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE VIEW [dbo].[CMIS_Off_Hd_DepositedM]
AS
SELECT     dbo.CMIS_Off_Hd.[ORDER], dbo.CMIS_Off_Hd.OR_NUM, dbo.CMIS_Off_Hd.OR_DATE, dbo.CMIS_BankDepo.DEPOSIT AS OR_AMT, dbo.CMIS_Off_Hd.DISCOUNT, 
                      dbo.CMIS_Off_Hd.TAX, dbo.CMIS_Off_Hd.CONSUMED, dbo.CMIS_Off_Hd.BAYADAMT, dbo.CMIS_Off_Hd.SUKLI, dbo.CMIS_Off_Hd.CASHAMOUNT, 
                      dbo.CMIS_Off_Hd.CHKAMOUNT, dbo.CMIS_Off_Hd.CARDAMOUNT, dbo.CMIS_Off_Hd.CUSCDE, dbo.CMIS_Off_Hd.CUSNAME, 
                      dbo.CMIS_Off_Hd.ADJUSTED, dbo.CMIS_Off_Hd.VARIOUS, dbo.CMIS_Off_Hd.PAIDNA, dbo.CMIS_Off_Hd.CANCEL, dbo.CMIS_Off_Hd.FORCE, 
                      dbo.CMIS_Off_Hd.BOUNCE, dbo.CMIS_Off_Hd.BANKCODE, dbo.CMIS_Off_Hd.BANKBRANCH, dbo.CMIS_Off_Hd.TSEKE, 
                      dbo.CMIS_Off_Hd.CARDBNKCDE, dbo.CMIS_Off_Hd.CARDNUMBER, dbo.CMIS_Off_Hd.TSEKLASE, dbo.CMIS_Off_Hd.CUTDATE, 
                      dbo.CMIS_Off_Hd.CHECKDATE, dbo.CMIS_Off_Hd.CARDDATE, dbo.CMIS_Off_Hd.DATECANCEL, dbo.CMIS_Off_Hd.TIMECANCEL, 
                      dbo.CMIS_Off_Hd.WHOCANCEL, dbo.CMIS_Off_Hd.DATECREATE, dbo.CMIS_Off_Hd.TIMECREATE, dbo.CMIS_Off_Hd.WHOCREATE, 
                      dbo.CMIS_Off_Hd.PRINTED, dbo.CMIS_Off_Hd.VALID, dbo.CMIS_Off_Hd.STATUS, dbo.CMIS_Off_Hd.VAT, dbo.CMIS_Off_Hd.ID, 
                      dbo.CMIS_BankDepo.DEPOSIT_TO, dbo.ALL_BANKS.BankName, dbo.ALL_BANKS.AcctCode AS BankAccountNo, dbo.CMIS_BankDepo.DATDEPOSIT, 
                      dbo.CMIS_Off_Hd.DEPOSIT1, dbo.CMIS_Off_Hd.DEPOSIT2, dbo.CMIS_Off_Hd.DEPOSIT3, dbo.CMIS_BankDepo.[TYPE] AS TOF
FROM         dbo.ALL_BANKS RIGHT OUTER JOIN
                      dbo.CMIS_BankDepo ON dbo.ALL_BANKS.BankCode = dbo.CMIS_BankDepo.DEPOSIT_TO LEFT OUTER JOIN
                      dbo.CMIS_Off_Hd ON dbo.CMIS_BankDepo.OR_NUM = dbo.CMIS_Off_Hd.OR_NUM
WHERE CMIS_BANKDEPO.TYPE <> 3
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


ALTER TABLE ALL_PROFILE
ADD		CUT_OFF_DATE		SMALLDATETIME


UPDATE CMIS_OFF_HD SET TOF1 = 1 WHERE TOF=1
UPDATE CMIS_OFF_HD SET TOF2 = 2 WHERE TOF=2
UPDATE CMIS_OFF_HD SET TOF3 = 3 WHERE TOF=3
UPDATE CMIS_OFF_HD SET DEPOSIT1 = 1 WHERE CASHAMOUNT > 0
UPDATE CMIS_OFF_HD SET DEPOSIT2 = 1 WHERE CHKAMOUNT > 0
UPDATE CMIS_OFF_HD SET DEPOSIT3 = 1 WHERE CARDAMOUNT > 0


ALTER TABLE CMIS_OFF_HD
ALTER COLUMN VAT INT NOT NULL

CREATE UNIQUE NONCLUSTERED INDEX INDX_ORNUM ON CMIS_OFF_HD (OR_NUM,VAT)