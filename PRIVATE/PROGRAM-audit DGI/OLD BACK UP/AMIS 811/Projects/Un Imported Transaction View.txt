USE [DMIS]
GO
/****** Object:  View [dbo].[AMIS_VW_UNIMPORTED_ISSUANCES]    Script Date: 07/27/2009 19:47:57 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW  [dbo].[AMIS_VW_UNIMPORTED_ISSUANCES]
as

SELECT TRANNO, TRANDATE AS DATE,'PARTS' AS [TYPE],  CUSTCODE AS CUSTOMERCODE, CUSTNAME AS CUSTOMERNAME, 'PARTS CASH ISSUANCES' AS DESCRIPTIONS, NETINVAMT  AS AMOUNT  FROM PMIS_VW_ISS_HISTORY WHERE (TRANTYPE = 'CSH' OR  TRANTYPE = 'CHG') AND TYPE='P' AND STATUS = 'P' AND TRANNO NOT IN
(SELECT  INVOICENO FROM AMIS_JOURNAL_HD WHERE JTYPE = 'SJ' AND INVOICETYPE = 'PI' AND STATUS<>'C')	
UNION
SELECT TRANNO, TRANDATE,'MATERIALS' AS [TYPE],  CUSTCODE, CUSTNAME , 'MATERIALS ISSUANCES' AS DESCRIPTIONS, NETINVAMT  AS AMOUNT  FROM PMIS_VW_ISS_HISTORY WHERE (TRANTYPE = 'CSH' OR  TRANTYPE = 'CHG') AND TYPE='M' AND STATUS = 'P' AND TRANNO NOT IN
(SELECT  INVOICENO FROM AMIS_JOURNAL_HD WHERE JTYPE = 'SJ' AND INVOICETYPE = 'MI')	
UNION
SELECT TRANNO, TRANDATE,'MATERIALS' AS [TYPE],  CUSTCODE, CUSTNAME , 'ACCESSORIES ISSUANCES' AS DESCRIPTIONS, NETINVAMT  AS AMOUNT  FROM PMIS_VW_ISS_HISTORY WHERE (TRANTYPE = 'CSH' OR  TRANTYPE = 'CHG') AND TYPE='A' AND STATUS = 'P' AND TRANNO NOT IN
(SELECT  INVOICENO FROM AMIS_JOURNAL_HD WHERE JTYPE = 'SJ' AND INVOICETYPE = 'AI')	
UNION
--PURELY INTERNAL
SELECT 
	CSMS_REPOR.REP_OR, DTE_COMP, 'SERVICE', ACCT_NO,NIYM, CSMS_REPOR.INVOICE, CSMS_REPOR.RO_AMOUNT
FROM CSMS_REPOR  
	WHERE 
INVOICE = 'INT RO' AND ISDATE(DTE_COMP )=1
AND REP_OR NOT IN 
(SELECT REFNO FROM AMIS_JOURNAL_HD WHERE STATUS<>'C' AND INVOICETYPE = 'SI' AND JTYPE='SJ' AND INVOICENO IN('INT RO'))
UNION
--SECOND QUERY 
SELECT CSMS_REPOR.REP_OR, DTE_COMP, 'SERVICE', ACCT_NO,NIYM, CSMS_REPOR.INVOICE, SUM(CSMS_RO_DET.DETPRC)
FROM CSMS_REPOR INNER JOIN CSMS_RO_DET ON 
CSMS_REPOR.REP_OR = CSMS_RO_DET.REP_OR 
WHERE INVOICE NOT IN('INT RO','NO CHG','PDI RO') AND RO_AMOUNT = 0 AND DETAMT > 0 AND (WCODE = 'S' OR WCODE = 'C') AND ISDATE(DTE_COMP) = 1  
AND INVOICE NOT IN
(SELECT INVOICENO FROM AMIS_JOURNAL_HD WHERE STATUS<>'C' AND INVOICETYPE = 'SI' AND JTYPE='SJ' AND INVOICENO NOT IN('INT RO','NO CHG','PDI RO'))
GROUP BY CSMS_REPOR.REP_OR,INVOICE,DTE_COMP,CSMS_REPOR.ACCT_NO,CSMS_REPOR.NIYM
UNION
--THIRD QUERY
SELECT 
CSMS_REPOR.REP_OR, DTE_COMP, 'SERVICE', ACCT_NO,NIYM, CSMS_REPOR.INVOICE, CSMS_REPOR.RO_AMOUNT 
FROM CSMS_REPOR WHERE 
RO_AMOUNT > 0 AND INVOICE NOT IN ('INT RO','NO CHG' ,'PDI RO') AND ISDATE(DTE_COMP)=1 AND
INVOICE NOT IN
(SELECT INVOICENO FROM AMIS_JOURNAL_HD WHERE STATUS<>'C' AND INVOICETYPE = 'SI' AND JTYPE='SJ' AND INVOICENO NOT IN('INT RO','NO CHG','PDI RO'))
UNION
--PURELY WARRANTY 
SELECT 
CSMS_REPOR.REP_OR, DTE_COMP, 'SERVICE', ACCT_NO,NIYM, CSMS_REPOR.INVOICE, SUM(CSMS_RO_DET.DETAMT) 
FROM CSMS_REPOR 
INNER JOIN CSMS_RO_DET ON CSMS_REPOR.REP_OR = CSMS_RO_DET.REP_OR 
WHERE RO_AMOUNT = 0 AND DETAMT > 0 AND WCODE = 'W' AND 
INVOICE NOT IN('INT RO','NO CHG','PDI RO') AND ISDATE(DTE_COMP)= 1 
AND
INVOICE NOT IN
(SELECT INVOICENO FROM AMIS_JOURNAL_HD WHERE STATUS<>'C' AND INVOICETYPE = 'SI' AND JTYPE='SJ' AND INVOICENO NOT IN('INT RO','NO CHG','PDI RO'))
GROUP BY CSMS_REPOR.REP_OR,INVOICE,CSMS_REPOR.DTE_COMP,CSMS_REPOR.ACCT_NO,CSMS_REPOR.NIYM
UNION
SELECT IGNKEY_NO,DATERELEASED,'SALES', CODE, (SELECT TOP 1 ACCTNAME FROM ALL_CUSTOMER WHERE CUSCDE=CODE), '[' + VI_NO  + ']' + MODEL, NETSALESPRICE  FROM SMIS_PURCHAGREE WHERE STATUS = 'P' AND ISDATE(DATERELEASED)=1  
AND VI_NO NOT IN 
(SELECT  INVOICENO FROM AMIS_JOURNAL_HD WHERE JTYPE = 'SJ' AND INVOICETYPE = 'VI' AND STATUS<>'C')	





 



GO
/****** Object:  View [dbo].[AMIS_VW_UNIMPORTED_OR]    Script Date: 07/27/2009 19:47:58 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW  [dbo].[AMIS_VW_UNIMPORTED_OR]
AS
SELECT OR_NUM TRANNO ,OR_DATE DATE , 'VAT OR'[TYPE], CUSCDE AS CUSTOMERCODE , CUSNAME AS CUSTOMERNAME, OR_AMT AS AMOUNT  FROM CMIS_OFF_HD 
WHERE (PAIDNA = 1 OR STATUS = 'P') AND ISDATE(OR_DATE )=1  AND CANCEL =0  AND VAT=1 AND 
 OR_NUM NOT IN 
(
	SELECT INVOICENO  FROM AMIS_JOURNAL_HD WHERE JTYPE = 'CRJ' AND LEFT(INVOICENO,2) <>'NV' AND STATUS<>'C'
)
UNION
SELECT OR_NUM ,OR_DATE, 'NON VAT OR', CUSCDE, CUSNAME, OR_AMT  FROM CMIS_OFF_HD 
WHERE (PAIDNA = 1 OR STATUS = 'P') AND ISDATE(OR_DATE )=1  AND CANCEL =0  AND VAT=0 AND 
 OR_NUM NOT IN 
(
SELECT RIGHT(INVOICENO,6) FROM AMIS_JOURNAL_HD WHERE JTYPE = 'CRJ' AND LEFT(INVOICENO,2) = 'NV' AND STATUS<>'C'
)
  




GO
/****** Object:  View [dbo].[AMIS_VW_UNIMPORTED_PURCHASE]    Script Date: 07/27/2009 19:47:58 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW  [dbo].[AMIS_VW_UNIMPORTED_PURCHASE]
as


SELECT  RRNO as Tranno, RRDATE as Date,'PARTS' AS [TYPE] ,RECVD_CODE AS VendorCode,RECVD_FROM as VendorName, 'Parts Receiving' AS Descriptions, TTLRRAMT  as Amount FROM PMIS_VW_RR_TRANS   WHERE 
TYPE ='P' AND STATUS = 'P' AND (CLASSCODE = 'PCG' OR CLASSCODE = 'PCS')  AND RRNO NOT IN
(SELECT  INVOICENO FROM AMIS_JOURNAL_HD WHERE JTYPE = 'APJ' AND INVOICETYPE = 'PARTS')	

UNION

SELECT RRNO, RRDATE,'MATERIALS' AS [TYPE] ,RECVD_CODE,RECVD_FROM , 'Material Recieving' AS DESCRIPT , TTLRRAMT  FROM PMIS_VW_RR_TRANS   WHERE 
TYPE ='M' AND STATUS = 'P' AND (CLASSCODE = 'PCG' OR CLASSCODE = 'PCS')  AND RRNO NOT IN
(SELECT  INVOICENO FROM AMIS_JOURNAL_HD WHERE JTYPE = 'APJ' AND INVOICETYPE = 'MATERIALS')	

UNION

SELECT RRNO, RRDATE,'PARTS' AS [TYPE] ,RECVD_CODE,RECVD_FROM , 'Accessories Recieving' AS DESCRIPT , TTLRRAMT  FROM PMIS_VW_RR_TRANS   WHERE 
TYPE ='A' AND STATUS = 'P' AND (CLASSCODE = 'PCG' OR CLASSCODE = 'PCS')  AND RRNO NOT IN
(SELECT  INVOICENO FROM AMIS_JOURNAL_HD WHERE JTYPE = 'APJ' AND INVOICETYPE = 'ACCESSORIES')	

UNION

SELECT SMIS_MRRINV.CODE,DATERECEIVED,'VEHICLE' AS [TYPE],SMIS_MRRINV.SOURCE, CSMS_SELLINGDEALER.DEALERNAME ,DESCRIPT,PURCHPRICE FROM SMIS_MRRINV 
LEFT OUTER JOIN CSMS_SELLINGDEALER ON SMIS_MRRINV.SOURCE = CSMS_SELLINGDEALER.DEALERCODE WHERE STATUS = 'P' 
